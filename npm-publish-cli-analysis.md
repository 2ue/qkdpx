# NPM快速发布CLI需求分析

## 需求概述

实现一个快速发布到npm的命令行工具，自动化版本管理和发布流程。

## 功能分析

### 核心功能模块

1. **变更检测模块**
   - 检测git工作区未提交的文件变更
   - 检测package.json版本是否需要更新
   - 验证当前分支状态

2. **交互式提交模块**
   - 询问用户是否进行自动提交
   - 交互式输入提交信息
   - 执行git add和git commit操作

3. **版本管理模块**
   - 自动升级package.json版本号
   - 支持major/minor/patch版本升级策略
   - 生成版本变更记录

4. **发布管理模块**
   - 自动检测.npmrc配置
   - 交互选择发布源(npm/私有源)
   - 支持多种认证方式(账号密码/token)
   - 执行构建和发布流程

## 推荐技术栈

### 核心依赖包

```json
{
  "inquirer": "^9.2.0",      // 交互式命令行界面
  "simple-git": "^3.19.1",  // Git操作封装
  "semver": "^7.5.4",       // 语义化版本管理
  "execa": "^7.2.0",        // 进程执行工具
  "chalk": "^5.3.0",        // 终端文字颜色
  "ora": "^7.0.1",          // 加载动画效果
  "fs-extra": "^11.1.1",    // 文件系统操作
  "commander": "^11.0.0",   // 命令行参数解析
  "listr2": "^6.6.1"        // 任务列表管理
}
```

### 工具特性说明

- **inquirer**: 提供丰富的交互式提示组件
- **simple-git**: 简化Git操作，支持Promise
- **semver**: 标准的语义化版本处理
- **execa**: 更好的child_process替代品
- **listr2**: 美观的任务执行列表

## 优化后的工作流程

### 建议流程顺序调整

**原需求顺序问题**: 第4步(提交版本)和第5步(构建发布)应该交换

### 优化后的执行流程

```
1. 变更检测阶段
   ├── 检测git工作区状态 (git status)
   ├── 检查是否有未提交的文件
   └── 验证当前分支和远程同步状态

2. 交互提交阶段
   ├── 询问是否自动提交当前变更
   ├── 交互式输入提交信息
   └── 执行git add . && git commit

3. 版本升级阶段
   ├── 检测当前版本号
   ├── 询问版本升级类型(patch/minor/major)
   └── 更新package.json版本

4. 构建验证阶段
   ├── 执行npm run build (如果存在)
   ├── 运行npm test (如果存在)
   └── 验证构建产物完整性

5. 版本提交阶段
   ├── 自动提交版本变更 (chore: bump version to x.x.x)
   ├── 创建git tag (vx.x.x)
   └── 推送到远程仓库

6. 发布配置阶段
   ├── 检测.npmrc配置文件
   ├── 交互选择发布registry
   └── 配置认证方式(token/账号密码)

7. 执行发布阶段
   ├── 显示发布摘要信息
   ├── 最终确认发布操作
   └── 执行npm publish
```

## 流程优化建议

### 1. 安全性增强
- **预检查机制**: 发布前检测必要的脚本(test, lint, build)
- **回滚机制**: 发布失败时自动回滚git操作
- **确认机制**: 关键操作前显示摘要并要求确认

### 2. 用户体验优化
- **配置文件支持**: `.dpxrc`配置默认选项
- **进度显示**: 使用listr2显示任务执行状态
- **错误处理**: 友好的错误信息和解决建议

### 3. 功能扩展
- **预发布版本**: 支持alpha/beta/rc版本发布
- **多包管理**: 支持monorepo场景
- **发布日志**: 自动生成CHANGELOG.md
- **通知集成**: 支持钉钉/飞书发布通知

### 4. 配置选项示例

```json
{
  "defaultVersionBump": "patch",
  "autoCommit": true,
  "skipTests": false,
  "skipBuild": false,
  "registry": "https://registry.npmjs.org/",
  "generateChangelog": true,
  "notifyWebhook": ""
}
```

## 技术实现要点

### 1. 错误处理策略
```javascript
// 使用try-catch包装异步操作
// 提供详细的错误信息和解决建议
// 实现优雅的进程退出
```

### 2. 交互设计原则
```javascript
// 提供清晰的选项说明
// 支持键盘快捷操作
// 合理的默认值设置
```

### 3. 配置管理
```javascript
// 支持多层级配置覆盖
// 环境变量优先级处理
// 配置文件验证机制
```

## 总结

通过调整第4步和第5步的顺序，将构建验证提前到版本提交之前，可以避免提交失败的构建版本。结合社区成熟的工具包和优化的交互流程，能够提供更安全、高效的npm发布体验。